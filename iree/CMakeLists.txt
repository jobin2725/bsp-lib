cmake_minimum_required(VERSION 3.20)

project(IREE_BareMetal
    LANGUAGES C CXX ASM
    VERSION 1.0.0
)

# C/C++ Standard
set(CMAKE_C_STANDARD 11)
set(CMAKE_C_STANDARD_REQUIRED ON)
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# Build Type
if(NOT CMAKE_BUILD_TYPE)
    set(CMAKE_BUILD_TYPE Debug)
endif()

# Output directories
set(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/bin)
set(CMAKE_LIBRARY_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib)
set(CMAKE_ARCHIVE_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib)

# ==============================================================================
# Paths
# ==============================================================================

# BSP location (parent directory)
set(BSP_DIR ${CMAKE_SOURCE_DIR}/..)

# IREE locations
set(IREE_DIR ${CMAKE_SOURCE_DIR}/../../iree)
set(IREE_BUILD_DIR ${IREE_DIR}/build-riscv)

# Model artifacts (generated by iree-compile)
set(MODEL_DIR ${CMAKE_SOURCE_DIR}/build/model)

# ==============================================================================
# BSP Configuration
# ==============================================================================

# Linker script from BSP
set(LINKER_SCRIPT ${BSP_DIR}/bsp/linker/rv64-virt.ld)

# ==============================================================================
# IREE bare-metal defines (same as toolchain)
# ==============================================================================

add_compile_definitions(
    IREE_PLATFORM_GENERIC=1
    IREE_SYNCHRONIZATION_DISABLE_UNSAFE=1
    IREE_FILE_IO_ENABLE=0
    IREE_DEVICE_SIZE_T=uint64_t
    PRIdsz=PRIu64
    IREE_ALLOCATOR_SYSTEM_CTL=iree_allocator_libc_ctl
)

# ==============================================================================
# Compile/Link Options
# ==============================================================================

add_compile_options(
    -Wall
    -ffreestanding
    -fno-common
    -ffunction-sections
    -fdata-sections
)

add_link_options(
    -T ${LINKER_SCRIPT}
    -Wl,-Map=${CMAKE_BINARY_DIR}/output.map
    -Wl,--gc-sections
    -nostartfiles
    -static
)

# ==============================================================================
# Include Paths
# ==============================================================================

include_directories(
    ${BSP_DIR}/bsp/include
    ${IREE_DIR}/runtime/src
    ${IREE_BUILD_DIR}/runtime/src
    ${MODEL_DIR}
)

# ==============================================================================
# IREE Runtime Libraries
# ==============================================================================

# Collect all IREE static libraries
set(IREE_RUNTIME_LIB_DIRS
    ${IREE_BUILD_DIR}/runtime/src/iree/runtime
    ${IREE_BUILD_DIR}/runtime/src/iree/base
    ${IREE_BUILD_DIR}/runtime/src/iree/base/internal
    ${IREE_BUILD_DIR}/runtime/src/iree/hal
    ${IREE_BUILD_DIR}/runtime/src/iree/hal/local
    ${IREE_BUILD_DIR}/runtime/src/iree/hal/local/loaders
    ${IREE_BUILD_DIR}/runtime/src/iree/hal/local/elf
    ${IREE_BUILD_DIR}/runtime/src/iree/hal/utils
    ${IREE_BUILD_DIR}/runtime/src/iree/hal/drivers/local_sync
    ${IREE_BUILD_DIR}/runtime/src/iree/vm
    ${IREE_BUILD_DIR}/runtime/src/iree/vm/bytecode
    ${IREE_BUILD_DIR}/runtime/src/iree/vm/bytecode/utils
    ${IREE_BUILD_DIR}/runtime/src/iree/modules/hal
    ${IREE_BUILD_DIR}/build_tools/third_party/flatcc
)

# IREE runtime libraries (order matters for static linking)
set(IREE_RUNTIME_LIBS
    ${IREE_BUILD_DIR}/runtime/src/iree/runtime/libiree_runtime_unified.a
    ${IREE_BUILD_DIR}/runtime/src/iree/hal/local/loaders/libiree_hal_local_loaders_static_library_loader.a
    ${IREE_BUILD_DIR}/build_tools/third_party/flatcc/libflatcc_parsing.a
    ${IREE_BUILD_DIR}/build_tools/third_party/flatcc/libflatcc_runtime.a
)

# ==============================================================================
# Source Files
# ==============================================================================

# BSP sources
set(BSP_SOURCES
    ${BSP_DIR}/bsp/startup/crt0.S
    ${BSP_DIR}/bsp/lib/syscalls.c
    ${BSP_DIR}/bsp/drivers/uart_ns16550a.c
)

# Model sources (embedded vmfb and static library object)
set(MODEL_SOURCES
    ${MODEL_DIR}/matmul_softmax_vmfb.c
)

# Application source
set(APP_SOURCES
    ${CMAKE_SOURCE_DIR}/src/main.c
)

# ==============================================================================
# Targets
# ==============================================================================

# Main firmware
add_executable(firmware
    ${BSP_SOURCES}
    ${MODEL_SOURCES}
    ${APP_SOURCES}
)

# Link against IREE runtime and model static library
target_link_libraries(firmware
    ${IREE_RUNTIME_LIBS}
    ${MODEL_DIR}/matmul_softmax.o
    m  # libm for math functions
)

# ==============================================================================
# vadd_i32 with Custom Accelerator
# ==============================================================================

set(MODEL_VADD_I32_DIR ${CMAKE_SOURCE_DIR}/build/model_vadd_i32)

# vadd_i32 firmware using custom accelerator kernel
add_executable(firmware_vadd_i32
    ${BSP_SOURCES}
    ${BSP_DIR}/bsp/drivers/adder_accelerator.c  # BSP accelerator driver
    ${MODEL_VADD_I32_DIR}/vadd_i32_vmfb.c
    ${CMAKE_SOURCE_DIR}/src/main_vadd_i32.c
    ${CMAKE_SOURCE_DIR}/src/vadd_i32_accel.c
)

target_include_directories(firmware_vadd_i32 PRIVATE
    ${MODEL_VADD_I32_DIR}
)

# Link against IREE runtime (but NOT vadd_i32.o - we use our own kernel)
target_link_libraries(firmware_vadd_i32
    ${IREE_RUNTIME_LIBS}
    m
)

# ==============================================================================
# Custom Targets
# ==============================================================================

# Disassembly
add_custom_target(disassembly
    COMMAND ${CMAKE_OBJDUMP} -D $<TARGET_FILE:firmware> > ${CMAKE_BINARY_DIR}/disassembly.txt
    DEPENDS firmware
    COMMENT "Generating disassembly..."
)

# Binary size
add_custom_target(size
    COMMAND ${CMAKE_SIZE} $<TARGET_FILE:firmware>
    DEPENDS firmware
    COMMENT "Binary size:"
)
